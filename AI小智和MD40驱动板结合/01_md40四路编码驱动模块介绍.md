# MD40 四路编码驱动模块

## 模块实物图

![模块实物图](picture/md40.png)

## 概述

此模块是一款基于CH32X035单片机的四路编码驱动模块，集成了四片SS6625E电机驱动芯片。该模块具有4个直流电机口(M0-M3)和4个编码电机口(E0-E3)，通过标准的I2C通信协议接收控制指令，驱动直流电机和编码电机，且提供完整的闭环控制解决方案，并支持信号反馈。

模块采用专业的PID控制算法，具备速度闭环和位置闭环控制功能，能够实现精确的转速维持和位置定位。通过编码器实时反馈，系统自动补偿负载变化，确保运动控制的稳定性和精确性。

MD40模块适用于需要高精度运动控制和多电机协同运动的应用场景，如移动机器人、自动化小车和多轴联动平台。

## 注意事项

- 此模块需要额外外接6-16V电源供电

## 模块参数

- 与开发板连线电压：5V

- 外接电源电压：6-16V

- 接 口：I2C接口和PH2.0间距接口，2pin (VIN G)的是外接电源接口，其余2pin的是直流电机接口(M0-M3)，6pin (- V B A G +)的是编码电机接口(E0-E3)

- 连接方式：PH2.0 防反接杜邦线

- 通信方式：I2C通信，地址0x16

- 尺 寸：56*40mm，兼容乐高积木和M4螺丝固定孔

| 引脚名称  | 描述        |
| -------- | ----------- |
| G        | GND地线      |
| V        | 5v电源引脚   |
| SDA      | I2C数据引脚  |
| SCL      | I2C时钟引脚  |

## 机械尺寸图

![机械尺寸图](picture/dimension_drawing.png)

## 编码概述

### 工作原理

MD40模块采用先进的数字信号处理技术，支持标准的AB相霍尔式编码电机(通过霍尔传感器、磁盘及减速电机组成的可精准控制的减速直流电机)。通过编码电机编码器输出的两路具有90度相位差的方波脉冲信号（A相和B相），为系统提供完整的运动信息，包括位置、运动速度和运动方向。

#### 脉冲计数机制

脉冲计数是指模块从编码电机编码器采集的AB相信号累计值，每个脉冲对应编码器转过一个最小角度单位。模块通过采集编码电机编码器输出的AB相信号，采用优化的单倍频计数技术，在编码器A相信号的下降沿触发计数脉冲，每个A相下降沿产生一个计数。

方向判断通过实时采样B相的电平状态实现：当A相下降沿时刻检测到B相电平与预设的相位关系电平一致时，判定为正转方向，脉冲计数器递增；当检测到B相电平与预设电平不一致时，判定为反转方向，脉冲计数器递减。

脉冲计数特性：

- 实时更新脉冲数据，每个A相下降沿立即更新计数值

- 精确方向判断，基于AB相位的严格正交关系

- 无累积误差设计，长期运行计数准确

- 支持正反向计数，正数表示正转，负数表示反转，完整记录电机旋转轨迹

#### 位置计算

位置是基于脉冲计数计算得出的电机输出轴绝对角度值，表示从参考零位开始累计的旋转角度。位置计算基于编码电机编码器产生的脉冲计数，通过精密的角度转换算法实现高精度位置反馈。系统支持多圈绝对位置记录，位置值通过以下精确公式计算：

**位置(度) = 脉冲计数 \* 360 / (编码电机编码器的每转脉冲数(PPR) \* 减速比)**

位置计算特性：

- 高分辨率位置反馈，通过编码器脉冲和减速比计算输出轴角度

- 支持多圈位置记录，满足长行程应用需求

- 每次编码器脉冲中断时立即更新位置值，确保控制响应及时性

- 位置值带有方向符号，正数表示正转，负数表示反转

#### 速度计算

速度是通过单位时间内脉冲计数的变化量计算得出的编码电机输出轴旋转速度，反映编码电机输出轴的实时转速，正负值表示旋转方向。速度计算采用优化的差分算法，通过测量固定采样窗口内的脉冲变化量来推导瞬时转速。计算公式如下：

**速度(RPM) = (当前脉冲计数 - 上次脉冲计数) \* 1000 \* 60 / (采样时间ms \* 编码电机编码器的每转脉冲数(PPR) \* 减速比)**

速度计算特性：

- 固定40ms采样窗口，平衡实时性与噪声抑制

- 使用滑动窗口平均滤波技术，有效抑制脉冲计数抖动

- 速度值带有方向符号，正数表示正转，负数表示反转

- 内置零速检测死区功能，避免低速时的误判和抖动

### 编码器配置

使用前需要正确配置编码电机编码器的基本参数，包括每转脉冲数、减速比和相位关系。

1. **每转脉冲数(PPR)：**定义编码电机编码器旋转一圈产生的脉冲数量

2. **减速比：**定义编码电机的电机轴转速与输出轴转速的比例关系

3. **相位关系：**定义编码电机的正转方向标准，支持两种配置模式：

    - A相领先B相（正转时A相信号相位超前B相90度）

    - B相领先A相（正转时B相信号相位超前A相90度）

### 闭环控制功能

#### 速度闭环控制

速度闭环控制系统采用先进的自适应PID算法，能够实时维持编码电机在设定转速下稳定运行。该系统具备负载自适应特性，能够自动检测和补偿因负载变化引起的转速波动，确保在不同工况下都能保持恒定的输出性能。

速度PID控制器包含三个独立可调的控制环节：

- **比例环节(P)：**提供速度快速响应能力

- **积分环节(I)：**消除速度稳态误差

- **微分环节(D)：**抑制速度超调和振荡

#### 位置闭环控制

位置闭环控制采用先进的双环控制架构，内环为速度控制，外环为位置控制。这种结构既能保证位置的精确性，又能确保运动过程的平稳性。

系统具备智能运动规划功能，在接近目标位置时自动降速，有效防止过冲现象。位置到达判断基于位置误差和速度状态双重条件，确保定位的准确性和可靠性。支持多圈绝对位置控制，满足长行程应用需求。

位置PID控制器包含三个独立可调的控制环节：

- **比例环节(P)：**提供位置快速响应能力

- **积分环节(I)：**消除位置稳态误差

- **微分环节(D)：**抑制位置超调和振荡

### 支持的编码电机

MD40模块用于驱动标准的AB相霍尔式编码电机，使用时需确保AB相信号保持90°正交关系，信号电平为3.3V/5V。模块采用6pin PH2.0间距接口 (- V B A G +)，能够驱动符合接口标准的AB相霍尔式编码电机。

## Arduino 应用

<a href="https://gh-proxy.com/https://github.com/emakefun-arduino-library/em_md40/archive/refs/tags/v1.0.0.zip" download>点击此处下载Arduino示例程序</a>

### Arduino 库使用文档

<a href="https://emakefun-arduino-library.github.io/em_md40/html/zh-CN/classem_1_1_md40.html" target="_blank">点击此处查看API说明文档</a>

### Arduino 库示例程序

<a href="https://emakefun-arduino-library.github.io/em_md40/html/zh-CN/dc_mode_run_pwm_duty_8ino-example.html" target="_blank">使用直流模式，以指定PWM占空比驱动电机</a>

<a href="https://emakefun-arduino-library.github.io/em_md40/html/zh-CN/encoder_mode_detect_phase_relation_8ino-example.html" target="_blank">根据电机正转时判断编码器AB相的实际相位关系</a>

<a href="https://emakefun-arduino-library.github.io/em_md40/html/zh-CN/encoder_mode_move_8ino-example.html" target="_blank">使用编码器模式，电机以指定的速度（单位RPM）相对移动±720位置</a>

<a href="https://emakefun-arduino-library.github.io/em_md40/html/zh-CN/encoder_mode_move_to_8ino-example.html" target="_blank">使用编码器模式，电机以指定的速度（单位RPM）在绝对位置0和720之间交替移动</a>

<a href="https://emakefun-arduino-library.github.io/em_md40/html/zh-CN/encoder_mode_position_control_8ino-example.html" target="_blank">使用编码器模式，电机位置设置功能演示</a>

<a href="https://emakefun-arduino-library.github.io/em_md40/html/zh-CN/encoder_mode_pulse_count_control_8ino-example.html" target="_blank">使用编码器模式，电机脉冲计数设置功能演示</a>

<a href="https://emakefun-arduino-library.github.io/em_md40/html/zh-CN/encoder_mode_run_pwm_duty_8ino-example.html" target="_blank">使用编码器模式，以指定PWM占空比驱动电机</a>

<a href="https://emakefun-arduino-library.github.io/em_md40/html/zh-CN/encoder_mode_run_speed_8ino-example.html" target="_blank">使用编码器模式，以指定的速度（单位RPM）驱动电机</a>

<a href="https://emakefun-arduino-library.github.io/em_md40/html/zh-CN/encoder_mode_run_speed_stop_8ino-example.html" target="_blank">使用编码器模式，周期性地启动和停止电机</a>

<a href="https://emakefun-arduino-library.github.io/em_md40/html/zh-CN/reset_8ino-example.html" target="_blank">初始化和重置电机</a>
