name: Markdown to PDF Converter

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:  # 允许手动触发

# 添加工作流级别的权限配置
permissions:
  contents: write  # 允许写入内容到仓库
  pages: write    # 允许部署到GitHub Pages
  id-token: write # 允许使用OIDC令牌

jobs:
  convert-md-to-pdf:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取所有历史，以便处理所有文件
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-xetex texlive-latex-extra texlive-fonts-recommended
          pandoc --version
      
      - name: Find Markdown files
        id: find-md
        run: |
          # 查找所有md文件，排除node_modules等目录
          MD_FILES=$(find . -name "*.md" -not -path "./.*" -not -path "*/node_modules/*" | sed 's/^\.\///')
          
          # 使用heredoc格式输出，避免特殊字符问题
          {
            echo "found_md_files<<EOF"
            echo "$MD_FILES"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          # 创建目录结构列表
          DIRS=$(find . -type f -name "*.md" -not -path "./.*" -not -path "*/node_modules/*" -exec dirname {} \; | sort -u | sed 's/^\.\///')
          {
            echo "dirs<<EOF"
            echo "$DIRS"
            echo "EOF"
          } >> $GITHUB_OUTPUT
      
      - name: Set up output directory
        run: |
          mkdir -p pdf_output
      
      - name: Convert Markdown to PDF
        run: |
          # 注意：使用heredoc格式时，输出变量已经是原始文本，无需解码
          # 但由于安全考虑，我们将输出存储到变量中
          MD_FILES="${{ steps.find-md.outputs.found_md_files }}"
          
          # 记录开始时间
          echo "开始转换Markdown文件到PDF..."
          echo "找到的文件列表:"
          echo "$MD_FILES"
          
          IFS=$'\n'
          converted_count=0
          failed_count=0
          
          for md_file in $MD_FILES; do
            # 跳过空行
            [ -z "$md_file" ] && continue
            
            # 获取文件名和目录
            dir_name=$(dirname "$md_file")
            base_name=$(basename "$md_file" .md)
            
            # 创建对应的输出目录
            mkdir -p "pdf_output/$dir_name"
            
            echo "正在转换: $md_file"
            
            # 转换PDF
            if [ -d "$dir_name/picture" ] || [ -d "$dir_name/resource" ]; then
              # 如果存在picture或resource目录，先复制资源
              mkdir -p "pdf_output/$dir_name"
              [ -d "$dir_name/picture" ] && cp -r "$dir_name/picture" "pdf_output/$dir_name/" 2>/dev/null || true
              [ -d "$dir_name/resource" ] && cp -r "$dir_name/resource" "pdf_output/$dir_name/" 2>/dev/null || true
            fi
            
            # 使用pandoc转换PDF
            if pandoc "$md_file" \
              -o "pdf_output/$dir_name/$base_name.pdf" \
              --pdf-engine=xelatex \
              -V geometry:margin=1in \
              -V colorlinks=true \
              -V linkcolor=blue \
              -V urlcolor=blue \
              --highlight-style=tango \
              -V lang=en 2>&1; then
              
              # 检查是否转换成功
              if [ -f "pdf_output/$dir_name/$base_name.pdf" ]; then
                echo "✓ 成功转换: $md_file -> pdf_output/$dir_name/$base_name.pdf"
                ((converted_count++))
              else
                echo "✗ 文件创建失败: $md_file"
                ((failed_count++))
              fi
            else
              echo "✗ pandoc转换失败: $md_file"
              ((failed_count++))
            fi
          done
          
          # 输出统计信息
          echo ""
          echo "================================"
          echo "转换完成!"
          echo "成功: $converted_count 个文件"
          echo "失败: $failed_count 个文件"
          echo "================================"
      
      - name: Create conversion summary
        run: |
          echo "# PDF Conversion Summary" > pdf_output/SUMMARY.md
          echo "" >> pdf_output/SUMMARY.md
          echo "Generated on: $(date)" >> pdf_output/SUMMARY.md
          echo "" >> pdf_output/SUMMARY.md
          echo "## Converted Files:" >> pdf_output/SUMMARY.md
          echo "" >> pdf_output/SUMMARY.md
          
          # 统计转换的PDF文件
          pdf_count=0
          find pdf_output -name "*.pdf" | while read pdf_file; do
            ((pdf_count++))
            rel_path=${pdf_file#pdf_output/}
            dir_name=$(dirname "$rel_path")
            base_name=$(basename "$pdf_file" .pdf)
            
            echo "- [$base_name.pdf]($rel_path)" >> pdf_output/SUMMARY.md
            if [ -d "pdf_output/$dir_name/picture" ]; then
              echo "  - Contains pictures" >> pdf_output/SUMMARY.md
            fi
            if [ -d "pdf_output/$dir_name/resource" ]; then
              echo "  - Contains resources" >> pdf_output/SUMMARY.md
            fi
          done
          
          echo "" >> pdf_output/SUMMARY.md
          echo "## Statistics" >> pdf_output/SUMMARY.md
          echo "- Total PDF files: $pdf_count" >> pdf_output/SUMMARY.md
          
          # 生成索引文件
          echo "# PDF 文件索引" > pdf_output/README.md
          echo "" >> pdf_output/README.md
          echo "此目录包含自动生成的PDF文件，由GitHub Actions工作流从Markdown文件转换而来。" >> pdf_output/README.md
          echo "" >> pdf_output/README.md
          echo "## 如何下载" >> pdf_output/README.md
          echo "1. 在工作流的Artifacts部分找到 'pdf-documents'" >> pdf_output/README.md
          echo "2. 点击下载整个压缩包" >> pdf_output/README.md
          echo "3. 解压后查看所有PDF文件" >> pdf_output/README.md
      
      - name: List generated PDFs
        run: |
          echo "生成的PDF文件列表:"
          find pdf_output -name "*.pdf" -type f | while read file; do
            size=$(du -h "$file" | cut -f1)
            echo "  - $file ($size)"
          done
          
          echo ""
          echo "目录结构:"
          tree pdf_output || ls -la pdf_output/
      
      - name: Upload PDF artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pdf-documents
          path: pdf_output/
          retention-days: 7
      
      - name: Upload to GitHub Releases (optional)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: pdf_output/**
      
      - name: Deploy to GitHub Pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./pdf_output
          publish_branch: gh-pages
          # 可选配置
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy PDF documents: ${{ github.sha }}'