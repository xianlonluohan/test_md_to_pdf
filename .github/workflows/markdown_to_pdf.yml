name: "Markdown to PDF Converter"

on:
  push:
    branches: ["main", "master"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  convert-md-to-pdf:
    runs-on: ubuntu-latest
    
    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: "Install dependencies"
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pandoc \
            texlive-xetex \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-fonts-extra \
            texlive-science \
            texlive-latex-recommended \
            lmodern \
            fonts-noto-cjk \
            fonts-noto-cjk-extra \
            fonts-wqy-microhei \
            fonts-wqy-zenhei \
            ghostscript \
            poppler-utils
      
      - name: "Create simple LaTeX template"
        run: |
          cat > template.tex << 'EOF'
          \documentclass[12pt]{article}
          \usepackage{xeCJK}
          \setCJKmainfont{Noto Serif CJK SC}
          \setCJKsansfont{Noto Sans CJK SC}
          \setCJKmonofont{Noto Sans Mono CJK SC}
          
          \usepackage[margin=1in]{geometry}
          \usepackage{graphicx}
          \usepackage{xcolor}
          \usepackage{hyperref}
          \hypersetup{
            colorlinks=true,
            linkcolor=blue,
            urlcolor=blue,
            citecolor=blue,
            pdfborder={0 0 0}
          }
          
          \usepackage{listings}
          \lstset{
            basicstyle=\ttfamily\small,
            backgroundcolor=\color{gray!10},
            frame=single,
            framerule=0.5pt,
            rulecolor=\color{gray!50},
            breaklines=true,
            breakatwhitespace=true,
            tabsize=2,
            numbers=none
          }
          
          \title{\$title\$}
          \author{}
          \date{\$date\$}
          
          \begin{document}
          
          \maketitle
          
          \$body\$
          
          \end{document}
          EOF
      
      - name: "Create output directory"
        run: |
          mkdir -p pdf_output
      
      - name: "Copy all resources"
        run: |
          echo "Copying all resource files..."
          
          # Copy all directories that might contain resources
          for dir in $(find . -type d -name "picture" -o -name "resource" -o -name "images" -o -name "img" 2>/dev/null); do
            rel_dir=$(echo $dir | sed 's|^\./||')
            mkdir -p "pdf_output/$rel_dir"
            cp -r "$dir"/* "pdf_output/$rel_dir/" 2>/dev/null || true
          done
          
          # Copy individual image files
          find . -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" -o -name "*.svg" -o -name "*.pdf" \) \
            -not -path "./.*" \
            -not -path "*/node_modules/*" \
            -not -path "*/pdf_output/*" \
            | while read img; do
                dir=$(dirname "$img" | sed 's|^\./||')
                mkdir -p "pdf_output/$dir"
                cp "$img" "pdf_output/$dir/" && echo "Copied: $img"
              done
      
      - name: "Convert Markdown files to PDF (Simple Method)"
        run: |
          echo "Converting Markdown files to PDF..."
          
          # Test with one file first
          test_file=$(find . -name "*.md" -not -path "./.*" -not -path "*/node_modules/*" -not -path "*/pdf_output/*" | head -1)
          
          if [ -z "$test_file" ]; then
            echo "No Markdown files found!"
            exit 1
          fi
          
          echo "Test file: $test_file"
          
          # Create output directory for test
          test_dir=$(dirname "$test_file")
          base_name=$(basename "$test_file" .md)
          mkdir -p "pdf_output/$test_dir"
          
          # Try a simple conversion
          pandoc "$test_file" \
            -o "pdf_output/$test_dir/$base_name.pdf" \
            --pdf-engine=xelatex \
            --template=template.tex \
            -V mainfont="DejaVu Sans" \
            -V geometry:margin=1in \
            -V lang=zh-CN \
            --verbose 2>&1 | tee test_conversion.log
          
          if [ -f "pdf_output/$test_dir/$base_name.pdf" ]; then
            echo "✓ Test conversion successful!"
            echo "File size: $(du -h "pdf_output/$test_dir/$base_name.pdf" | cut -f1)"
          else
            echo "✗ Test conversion failed"
            cat test_conversion.log
            exit 1
          fi
      
      - name: "Convert all Markdown files"
        run: |
          echo "Starting batch conversion..."
          
          MD_FILES=$(find . -name "*.md" -not -path "./.*" -not -path "*/node_modules/*" -not -path "*/pdf_output/*" | sed 's/^\.\///')
          
          total_count=0
          success_count=0
          fail_count=0
          
          for md_file in $MD_FILES; do
            total_count=$((total_count + 1))
            echo ""
            echo "Processing [$total_count]: $md_file"
            
            dir_name=$(dirname "$md_file")
            base_name=$(basename "$md_file" .md)
            
            mkdir -p "pdf_output/$dir_name"
            
            # Extract and copy resources for this file
            if [ -d "$dir_name/picture" ]; then
              mkdir -p "pdf_output/$dir_name/picture"
              cp -r "$dir_name/picture"/* "pdf_output/$dir_name/picture/" 2>/dev/null || true
            fi
            
            if [ -d "$dir_name/resource" ]; then
              mkdir -p "pdf_output/$dir_name/resource"
              cp -r "$dir_name/resource"/* "pdf_output/$dir_name/resource/" 2>/dev/null || true
            fi
            
            # Build resource path
            resource_path="$dir_name:.:./pdf_output"
            
            # Convert with minimal options
            pandoc "$md_file" \
              --resource-path="$resource_path" \
              -o "pdf_output/$dir_name/$base_name.pdf" \
              --pdf-engine=xelatex \
              --template=template.tex \
              -V mainfont="Noto Serif CJK SC" \
              -V sansfont="Noto Sans CJK SC" \
              -V monofont="Noto Sans Mono CJK SC" \
              -V geometry:margin=1in \
              -V colorlinks=true \
              -V lang=zh-CN \
              -V papersize=a4 \
              --wrap=auto \
              -f markdown \
              -t pdf \
              --verbose 2>&1 | tee -a conversion.log | tail -20
            
            if [ $? -eq 0 ] && [ -f "pdf_output/$dir_name/$base_name.pdf" ] && [ -s "pdf_output/$dir_name/$base_name.pdf" ]; then
              echo "✓ Success: $md_file"
              success_count=$((success_count + 1))
            else
              echo "✗ Failed: $md_file"
              fail_count=$((fail_count + 1))
            fi
          done
          
          echo ""
          echo "========================================="
          echo "Conversion Summary:"
          echo "Total files: $total_count"
          echo "Successful: $success_count"
          echo "Failed: $fail_count"
          echo "========================================="
          
          if [ $success_count -eq 0 ]; then
            echo "ERROR: No files were converted successfully!"
            echo "Last 50 lines of conversion log:"
            tail -50 conversion.log
            exit 1
          fi
      
      - name: "Verify PDF files"
        run: |
          echo "Verifying generated PDF files..."
          
          pdf_files=$(find pdf_output -name "*.pdf" -type f 2>/dev/null | wc -l)
          
          if [ $pdf_files -eq 0 ]; then
            echo "ERROR: No PDF files generated!"
            exit 1
          fi
          
          echo "Found $pdf_files PDF files:"
          find pdf_output -name "*.pdf" -type f | while read pdf; do
            size=$(du -h "$pdf" | cut -f1)
            echo "  $pdf ($size)"
          done
          
          # Check if files are valid PDFs
          echo ""
          echo "Checking PDF validity..."
          invalid_count=0
          find pdf_output -name "*.pdf" -type f | while read pdf; do
            if ! pdfinfo "$pdf" >/dev/null 2>&1; then
              echo "  Invalid PDF: $pdf"
              invalid_count=$((invalid_count + 1))
            fi
          done
          
          if [ $invalid_count -gt 0 ]; then
            echo "ERROR: Found $invalid_count invalid PDF files!"
            exit 1
          fi
      
      - name: "Create index file"
        run: |
          echo "# Generated PDF Files" > pdf_output/README.md
          echo "" >> pdf_output/README.md
          echo "Generated on: $(date '+%Y-%m-%d %H:%M:%S')" >> pdf_output/README.md
          echo "" >> pdf_output/README.md
          echo "## File List" >> pdf_output/README.md
          echo "" >> pdf_output/README.md
          
          find pdf_output -name "*.pdf" -type f | sort | while read pdf; do
            rel_path=${pdf#pdf_output/}
            dir_name=$(dirname "$rel_path")
            file_name=$(basename "$rel_path")
            file_size=$(du -h "$pdf" | cut -f1)
            
            if [ "$dir_name" != "." ]; then
              echo "### $dir_name/" >> pdf_output/README.md
              echo "" >> pdf_output/README.md
            fi
            
            echo "- [$file_name]($rel_path) ($file_size)" >> pdf_output/README.md
          done
      
      - name: "Upload artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: pdf-documents
          path: pdf_output/
          retention-days: 7